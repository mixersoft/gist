<?xml version="1.0" encoding="UTF-8"?>
<Wix
	xmlns       = "http://schemas.microsoft.com/wix/2006/wi"
	xmlns:netfx = "http://schemas.microsoft.com/wix/NetFxExtension"
	>
	<Product
		Id           = "8ED4EAEB-A127-49A3-B8AE-18066F17A6FF"
		Name         = "Snaphappi Helper"
		Language     = "1033"
		Version      = "1.0.0.0"
		Manufacturer = "Snaphappi"
		UpgradeCode  = "3C0A9E56-59BB-4609-B137-6FFBD6B0C979"
		>
		<Package
			InstallerVersion = "200"
			Compressed       = "yes"
			InstallScope     = "perMachine"
			/>

		<MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

		<MediaTemplate EmbedCab="yes" />

		<Feature Id="ProductFeature" Title="Snaphappi helper app" Level="1">
			<ComponentGroupRef Id="ProductComponents" />
		</Feature>

		<InstallExecuteSequence>
			<Custom Action="DeviceID" After="InstallFiles">NOT Installed</Custom>
		</InstallExecuteSequence>

		<UIRef Id="WixUI_Minimal" />
		<WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
	</Product>

	<Fragment>
		<!-- Device ID registration. -->
		<CustomAction
			Id          = "DeviceID"
			BinaryKey   = "DeviceID_Dll"
			DllEntry    = "InstallDeviceID"
			Execute     = "deferred"
			Return      = "ignore"
			Impersonate = "no"
			/>
		<Binary Id="DeviceID_Dll" SourceFile="$(var.InstallDeviceID.TargetDir)\InstallDeviceID.CA.dll" />
	</Fragment>

	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="ProgramFilesFolder">
				<Directory Id="INSTALLFOLDER" Name="Uploader">
					
					<!-- The executable together with its protocol handler. -->
					<Component Id="ProductComponent">
						<!-- Main application file. -->
						<File Id="ProductExe" Source="$(var.client.TargetPath)" />
						<!-- Protocol handler registry entry. -->
						<RegistryKey Key="snaphappi" Root="HKCR">
							<RegistryValue Value="URL:Snaphappi Protocol" Type="string" />
							<RegistryValue Name="URL Protocol" Value="" Type="string" />
							<RegistryKey Key="DefaultIcon">
								<RegistryValue Value='"[#ProductExe]",0' Type="string" />
							</RegistryKey>
							<RegistryKey Key="shell">
								<RegistryKey Key="open">
									<RegistryKey Key="command">
										<RegistryValue Value='"[#ProductExe]" "%1"' Type="string" />
									</RegistryKey>
								</RegistryKey>
							</RegistryKey>
						</RegistryKey>
					</Component>
					
					<!-- The main configuration file. -->
					<Component Id="ProductConfigComponent">
						<File Id="ProductConfig" Source="$(var.client.TargetPath).config" />
					</Component>

					<!-- The Task Scheduler library. -->
					<Component Id="TaskSchedulerComponent">
						<File Id="TaskSchedulerDll" Source="$(var.client.ProjectDir)\lib\Microsoft.Win32.TaskScheduler.dll" />
					</Component>
					
					<!-- The Thrift library. -->
					<Component Id="ThriftComponent">
						<File Id="ThriftDll" Source="$(var.client.ProjectDir)\lib\Thrift.dll" />
					</Component>
					
					<!-- The ImageMagick app. -->
					<?define ImageMagick="..\..\common\ImageMagick" ?>
					<Directory Id="ImageMagickDir" Name="ImageMagick" >
						<Component Id="ImageMagick" Guid="67A00421-C52C-4213-91AD-FF84833CAD13">
							<File Source="$(var.ImageMagick)\atl90.dll" />
							<File Source="$(var.ImageMagick)\coder.xml" />
							<File Source="$(var.ImageMagick)\colors.xml" />
							<File Source="$(var.ImageMagick)\configure.xml" />
							<File Source="$(var.ImageMagick)\convert.exe" KeyPath="yes" />
							<File Source="$(var.ImageMagick)\delegates.xml" />
							<File Source="$(var.ImageMagick)\english.xml" />
							<File Source="$(var.ImageMagick)\ImageMagick.rdf" />
							<File Source="$(var.ImageMagick)\locale.xml" />
							<File Source="$(var.ImageMagick)\log.xml" />
							<File Source="$(var.ImageMagick)\magic.xml" />
							<File Source="$(var.ImageMagick)\mfc90.dll" />
							<File Source="$(var.ImageMagick)\Microsoft.VC90.ATL.manifest" />
							<File Source="$(var.ImageMagick)\Microsoft.VC90.CRT.manifest" />
							<File Source="$(var.ImageMagick)\Microsoft.VC90.MFC.manifest" />
							<File Source="$(var.ImageMagick)\Microsoft.VC90.OpenMP.manifest" />
							<File Source="$(var.ImageMagick)\msvcp90.dll" />
							<File Source="$(var.ImageMagick)\msvcr90.dll" />
							<File Source="$(var.ImageMagick)\NOTICE" />
							<File Source="$(var.ImageMagick)\policy.xml" />
							<File Source="$(var.ImageMagick)\sRGB.icm" />
							<File Source="$(var.ImageMagick)\thresholds.xml" />
							<File Source="$(var.ImageMagick)\type-ghostscript.xml" />
							<File Source="$(var.ImageMagick)\type.xml" />
							<File Source="$(var.ImageMagick)\vcomp90.dll" />
							<File Source="$(var.ImageMagick)\X11.dll" />
							<File Source="$(var.ImageMagick)\Xext.dll" />
						</Component>
					</Directory>
					
				</Directory>
			</Directory>
		</Directory>
	</Fragment>

	<Fragment>
		<PropertyRef Id="NETFRAMEWORK35" />
		<Condition Message="This application requires .NET Framework 3.5. Please install the .NET Framework then run this installer again.">
			<![CDATA[Installed OR NETFRAMEWORK35]]>
		</Condition>
		
		<ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
			<ComponentRef Id="ProductComponent" />
			<ComponentRef Id="ProductConfigComponent" />
			<ComponentRef Id="TaskSchedulerComponent" />
			<ComponentRef Id="ThriftComponent" />
			<ComponentRef Id="ImageMagick" />
		</ComponentGroup>
	</Fragment>
</Wix>